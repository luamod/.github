name: Generate Docs
# Runs the shared lls_types_export.lua script from this workflow repo.

on:
  workflow_call:
    inputs:
      lua_version:
        description: Lua version used to run lls_types_export.lua
        required: false
        type: string
        default: "5.4"
      types_dir:
        description: Directory containing input .lua files
        required: true
        type: string
      output_dir:
        description: Directory where rendered files are written
        required: true
        type: string
      output_ext:
        description: Output file extension (without leading dot)
        required: false
        type: string
        default: md
      export_script:
        description: Export script path passed to --export-script
        required: true
        type: string
      exclude:
        description: Optional space-separated list passed to --exclude
        required: false
        type: string
        default: ""
      pr_base:
        description: Base branch for the generated pull request
        required: false
        type: string
        default: main
      pr_branch:
        description: Branch name used for the generated pull request
        required: false
        type: string
        default: docs-regenerate

jobs:
  gdocs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Resolve Workflow Tools Ref
        run: |
          TOOLS_REF="${{ github.workflow_ref }}"
          TOOLS_REF="${TOOLS_REF##*@}"
          echo "TOOLS_REF=$TOOLS_REF" >> "$GITHUB_ENV"

      - name: Checkout Workflow Tools
        uses: actions/checkout@v6
        with:
          repository: luamod/.github
          ref: ${{ env.TOOLS_REF }}
          path: .workflow-tools

      - name: Setup Lua
        uses: leafo/gh-actions-lua@v12
        with:
          luaVersion: ${{ inputs.lua_version }}

      - name: Resolve and Verify Lua Runtime
        run: |
          LUA_CMD=""
          if [ "${{ inputs.lua_version }}" = "luajit" ]; then
            for c in luajit lua; do
              if command -v "$c" >/dev/null 2>&1; then
                LUA_CMD="$c"
                break
              fi
            done
          else
            for c in "lua${{ inputs.lua_version }}" lua; do
              if command -v "$c" >/dev/null 2>&1; then
                LUA_CMD="$c"
                break
              fi
            done
          fi

          if [ -z "$LUA_CMD" ]; then
            echo "Unable to resolve Lua command for version: ${{ inputs.lua_version }}"
            exit 1
          fi

          echo "LUA_CMD=$LUA_CMD" >> "$GITHUB_ENV"
          "$LUA_CMD" -v
          "$LUA_CMD" -v 2>&1 | grep -qi "${{ inputs.lua_version }}" || {
            echo "Expected Lua version: ${{ inputs.lua_version }}"
            exit 1
          }

      - name: Setup Node
        if: ${{ inputs.output_ext == 'md' }}
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Run lls_types_export.lua
        run: |
          cmd=(
            "$LUA_CMD" ".workflow-tools/scripts/lls_types_export.lua"
            --types-dir "${{ inputs.types_dir }}"
            --output-dir "${{ inputs.output_dir }}"
            --output-ext "${{ inputs.output_ext }}"
          )

          if [ -n "${{ inputs.export_script }}" ]; then
            cmd+=(--export-script "${{ inputs.export_script }}")
          fi

          if [ -n "${{ inputs.exclude }}" ]; then
            cmd+=(--exclude "${{ inputs.exclude }}")
          fi

          "${cmd[@]}"

      - name: Format Markdown Output
        if: ${{ inputs.output_ext == 'md' }}
        run: npx --yes prettier@3 --write "${{ inputs.output_dir }}/**/*.md"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v8
        with:
          commit-message: "chore(docs): auto-generate docs"
          title: "chore(docs): auto-generate docs"
          body: "Automated docs update generated by shared workflow script."
          base: ${{ inputs.pr_base }}
          branch: ${{ inputs.pr_branch }}
          delete-branch: true
          add-paths: |
            ${{ inputs.output_dir }}/**
