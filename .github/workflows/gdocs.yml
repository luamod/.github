name: Generate Docs
# Runs scripts/lls_types_export.lua to generate docs using the provided export script.

on:
  workflow_call:
    inputs:
      lua_version:
        description: Lua version used to run lls_types_export.lua
        required: false
        type: string
        default: "5.4"
      types_dir:
        description: Directory containing input .lua files
        required: true
        type: string
      output_dir:
        description: Directory where rendered files are written
        required: true
        type: string
      output_ext:
        description: Output file extension (without leading dot)
        required: false
        type: string
        default: md
      export_script:
        description: Export script path passed to --export-script
        required: true
        type: string
      exclude:
        description: Optional space-separated list passed to --exclude
        required: false
        type: string
        default: ""
      pr_base:
        description: Base branch for the generated pull request
        required: false
        type: string
        default: main
      pr_branch:
        description: Branch name used for the generated pull request
        required: false
        type: string
        default: docs-regenerate

jobs:
  gdocs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Setup Lua
        uses: leafo/gh-actions-lua@v12
        with:
          luaVersion: ${{ inputs.lua_version }}

      - name: Setup Node
        if: ${{ inputs.output_ext == 'md' }}
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Run lls_types_export.lua
        run: |
          cmd=(
            lua "scripts/lls_types_export.lua"
            --types-dir "${{ inputs.types_dir }}"
            --output-dir "${{ inputs.output_dir }}"
            --output-ext "${{ inputs.output_ext }}"
          )

          if [ -n "${{ inputs.export_script }}" ]; then
            cmd+=(--export-script "${{ inputs.export_script }}")
          fi

          if [ -n "${{ inputs.exclude }}" ]; then
            cmd+=(--exclude "${{ inputs.exclude }}")
          fi

          "${cmd[@]}"

      - name: Format Markdown Output
        if: ${{ inputs.output_ext == 'md' }}
        run: npx --yes prettier@3 --write "${{ inputs.output_dir }}/**/*.md"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v8
        with:
          commit-message: "chore(docs): auto-generate docs"
          title: "chore(docs): auto-generate docs"
          body: "Automated docs update generated by `scripts/lls_types_export.lua`."
          base: ${{ inputs.pr_base }}
          branch: ${{ inputs.pr_branch }}
          delete-branch: true
          add-paths: |
            ${{ inputs.output_dir }}/**
